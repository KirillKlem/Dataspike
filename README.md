
# Country Detection from Identity Documents

> ⚠️ **Disclaimer**
>
> Это тестовое сделано в сжатые сроки (пару часов), основные идеи не протестированы, о них далееЗато:
> - есть **рабочий прототип** с адекватной архитектурой;
> - подробно описаны **соображения/компромиссы**, почему выбран именно такой дизайн;
> - заложены **крючки для масштабирования** на сотни стран и документы **без MRZ**.

---

## TL;DR

- Вместо «наивной» image-classification по ISO-классам — **OCR-first** пайплайн:  
  **MRZ (жёстко)** → **мультиязычные алиасы стран (словарь + fuzzy)** → **языковой fallback**.
- Даёт explainable вывод и естественно переносится на **ID/driver licenses/voter cards**, где MRZ нет.
- В ноутбуке OCR гонялся на **CPU** (поэтому медленно). На **GPU (T4)** с `paddlepaddle-gpu` и нужными флагами — inference стабильно < **1 сек**.

---

## Почему **не** использовать Image Classification

**Image classifier (ResNet18 и прочее)**:
- ❌ Плохо обобщается на unseen классы (нужно переобучение под каждую новую страну)
- ❌ Хрупкость к стилю и внешнему виду документа (цветность, скан, освещение)
- ❌ MRZ и текстовая информация вообще игнорируются
- ✅ Может быть полезным как доп. модальность (например, для verification)

**OCR-first подход**:
- ✅ Позволяет "читать" стандартизированные текстовые признаки (MRZ, страна, язык, город и т.д.)
- ✅ Масштабируется: чтобы добавить страну, не надо переобучать модель
- ✅ Объясним: видим текст и знаем, почему и как было принято решение

---

## Архитектура пайплайна

```text
[Изображение документа]
       ↓
[Multilingual OCR (PaddleOCR 3.0)]
       ↓
[Raw текст из документа]
       ↓
[Country Resolver]:
    1. MRZ-разбор → ISO-код страны
    2. Fuzzy match: словарь названий стран на разных языках
    3. Language detection (langdetect → ISO-lang → plausible country)
       ↓
[Возвращаем: ISO3, ISO2, имя страны, confidence, источник]
```

---

## Выбор OCR

Используем [PaddleOCR 3.0](https://github.com/PaddlePaddle/PaddleOCR):
- Multilingual (80+ языков), без необходимости указывать язык
- Поддерживает обработку полной страницы сразу
- Хорошая интеграция в пайплайны (структурированный JSON, bounding boxes, текст)

OCR — самая дорогая операция, но при использовании GPU можно укладываться в адекватные рамки ().  
Также возможна замена на `MonkeyOCR`, `MiniCPM-o`, `SmolDocling` и др. — но это требует доп. интеграции.

---

## Как определяется страна

1. **MRZ zone**  
   - Регулярки по шаблонам `P<USA`, `IDFRA`, `XXX123456`
   - ISO-код достаётся напрямую
   - Если такой код не входит в классы (в список стран) — идём дальше

2. **Country aliases**  
   - Словарь названий стран на разных языках (напр., "Deutschland", "République Française", "Francia")
   - Поиск через `RapidFuzz` с настройкой threshold
   - Работает даже с OCR-ошибками (напр. `FRAHC` → `France`)

3. **Language fallback**  
   - Используем `langdetect` → ISO 639-1 → возможные страны
   - Например, `tr` → Turkey, `pl` → Poland
   - Даёт слабый сигнал, но полезен, если всё остальное не сработало

---

## Почему это решение масштабируется

- Документы без MRZ: алгоритм fallback'ов работает по языку + словам
- Новые страны: просто расширяем словарь
- ID-карты, водительские и прочее: архитектура не привязана к конкретной верстке паспорта
- Модель не "зашита" в fixed set стран — вся логика "в данных"

---

## Пример

```python
['BELGIE', 'BELGIQUE', 'BELGIEN', 'BELGIUM', ..., 'P<BELCAPP<<RAFAEL', '0XCS6N4RP0BEL3205057M2508197']
→ MRZ → BEL ✅
→ Aliases: "Belgium", "Belgique", ...
→ Langs: ["nl", "fr", "de"]
```

---

## Что можно улучшить (и как)

- [ ] Подключить альтернативный OCR (например, `MonkeyOCR`, `MiniCPM-o`)
- [ ] Добавить confidence-схему между MRZ / alias / lang
- [ ] Ввести классы “не определено” / “многозначно”
- [ ] Ускорить inference при батчевом запуске
- [ ] Сделать CLI/REST wrapper для быстрой интеграции в прод
